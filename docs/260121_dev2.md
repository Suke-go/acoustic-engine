# Acoustic Engine プラグイン・DLL統合要件定義書

> **文書ID**: 260121_dev2  
> **作成日**: 2026-01-21  
> **目的**: ネイティブプラグイン・DLL統合仕様

---

## 1. 概要

本文書は、Acoustic Engine を外部アプリケーション（ゲームエンジン、DAW、カスタムアプリケーション）に統合するための設計指針と実装要件を定義する。

### 1.1 対象プラットフォーム

| プラットフォーム | 形式 | 優先度 |
|----------------|------|--------|
| Unity | C# P/Invoke | Phase 1 |
| Unreal Engine | C++ Plugin | Phase 2 |
| VST3 / AU | Audio Plugin | Phase 2 |
| TouchDesigner | Python / C++ | Phase 3 |
| Max/MSP | External Object | Phase 3 |

---

## 2. 設計原則

### 2.1 ABI安定性

| 原則 | 実装方法 |
|-----|---------|
| **Pure C API** | `extern "C"` ラッパー、C++ マングリング回避 |
| **Opaque Handle** | `typedef struct ae_engine ae_engine_t;` で内部構造隠蔽 |
| **固定サイズ型** | `uint32_t`, `float` など明示的サイズ型のみ使用 |
| **明示的パッキング** | `#pragma pack` またはコンパイラ属性で構造体サイズ固定 |

### 2.2 スレッドモデル

```
┌─────────────────────────────────────────────────────────────┐
│                      Thread Model                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  [UI Thread]                    [Audio Thread]              │
│      │                               │                      │
│      │ ae_set_distance()             │                      │
│      │ ae_set_room_size()            │                      │
│      │ ae_apply_scenario()           │                      │
│      │        │                      │                      │
│      │        ▼                      │                      │
│      │  ┌──────────────┐             │                      │
│      │  │ Atomic Params│◀────────────┤ ae_process()        │
│      │  └──────────────┘             │                      │
│      │                               │                      │
│  [Background Thread]                 │                      │
│      │                               │                      │
│      │ ae_load_preset()              │                      │
│      │ (non-blocking read)           │                      │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 2.3 RT-Safe 関数一覧

| 関数 | RT-Safe | 備考 |
|-----|---------|------|
| `ae_process()` | ✅ | ヒープ割り当てなし、ロックなし |
| `ae_set_distance()` | ✅ | アトミック書き込み |
| `ae_set_room_size()` | ✅ | アトミック書き込み |
| `ae_set_brightness()` | ✅ | アトミック書き込み |
| `ae_set_width()` | ✅ | アトミック書き込み |
| `ae_set_dry_wet()` | ✅ | アトミック書き込み |
| `ae_set_intensity()` | ✅ | アトミック書き込み |
| `ae_apply_scenario()` | ⚠️ | パラメータ展開のみRT-safe |
| `ae_create_engine()` | ❌ | ヒープ割り当て |
| `ae_destroy_engine()` | ❌ | ヒープ解放 |
| `ae_load_preset()` | ❌ | ファイルI/O |

---

## 3. Unity 統合

### 3.1 C# バインディング

```csharp
// AcousticEngineNative.cs
using System;
using System.Runtime.InteropServices;

public static class AcousticEngineNative
{
    #if UNITY_EDITOR_WIN || UNITY_STANDALONE_WIN
    private const string DLL = "acoustic_engine";
    #elif UNITY_EDITOR_OSX || UNITY_STANDALONE_OSX
    private const string DLL = "acoustic_engine";
    #elif UNITY_STANDALONE_LINUX
    private const string DLL = "acoustic_engine";
    #else
    private const string DLL = "__Internal";
    #endif

    [DllImport(DLL)] public static extern IntPtr ae_create_engine(ref AeConfig config);
    [DllImport(DLL)] public static extern void ae_destroy_engine(IntPtr engine);
    [DllImport(DLL)] public static extern int ae_process(IntPtr engine, ref AeBuffer input, ref AeBuffer output);
    [DllImport(DLL)] public static extern int ae_set_distance(IntPtr engine, float value);
    [DllImport(DLL)] public static extern int ae_set_room_size(IntPtr engine, float value);
    [DllImport(DLL)] public static extern int ae_apply_scenario(IntPtr engine, string name, float intensity);
    [DllImport(DLL)] public static extern AeConfig ae_get_default_config();
}

[StructLayout(LayoutKind.Sequential)]
public struct AeConfig
{
    public uint sampleRate;
    public uint maxBufferSize;
    public IntPtr dataPath;
    public IntPtr hrtfPath;
    [MarshalAs(UnmanagedType.I1)] public bool preloadHrtf;
    [MarshalAs(UnmanagedType.I1)] public bool preloadAllPresets;
    public UIntPtr maxReverbTimeSec;
}

[StructLayout(LayoutKind.Sequential)]
public struct AeBuffer
{
    public IntPtr samples;
    public UIntPtr frameCount;
    public byte channels;
    [MarshalAs(UnmanagedType.I1)] public bool interleaved;
}
```

### 3.2 高レベルラッパー

```csharp
// AcousticEngine.cs
public class AcousticEngine : IDisposable
{
    private IntPtr _handle;
    private bool _disposed;

    public AcousticEngine()
    {
        var config = AcousticEngineNative.ae_get_default_config();
        _handle = AcousticEngineNative.ae_create_engine(ref config);
    }

    public void SetScenario(string name, float intensity = 1.0f)
        => AcousticEngineNative.ae_apply_scenario(_handle, name, intensity);

    public float Distance
    {
        set => AcousticEngineNative.ae_set_distance(_handle, value);
    }

    public float RoomSize
    {
        set => AcousticEngineNative.ae_set_room_size(_handle, value);
    }

    public void Process(float[] data, int channels)
    {
        var handle = GCHandle.Alloc(data, GCHandleType.Pinned);
        try
        {
            var buf = new AeBuffer
            {
                samples = handle.AddrOfPinnedObject(),
                frameCount = (UIntPtr)(data.Length / channels),
                channels = (byte)channels,
                interleaved = true
            };
            AcousticEngineNative.ae_process(_handle, ref buf, ref buf);
        }
        finally { handle.Free(); }
    }

    public void Dispose()
    {
        if (!_disposed && _handle != IntPtr.Zero)
        {
            AcousticEngineNative.ae_destroy_engine(_handle);
            _handle = IntPtr.Zero;
            _disposed = true;
        }
    }
}
```

### 3.3 Unity コンポーネント

```csharp
// AcousticEngineAudioFilter.cs
[RequireComponent(typeof(AudioSource))]
public class AcousticEngineAudioFilter : MonoBehaviour
{
    [Range(0.1f, 1000f)] public float distance = 10f;
    [Range(0f, 1f)] public float roomSize = 0.5f;
    public string scenario = "deep_sea";
    [Range(0f, 1f)] public float scenarioIntensity = 1f;

    private AcousticEngine _engine;

    void OnEnable() => _engine = new AcousticEngine();
    void OnDisable() => _engine?.Dispose();

    void Update()
    {
        _engine.Distance = distance;
        _engine.RoomSize = roomSize;
    }

    void OnAudioFilterRead(float[] data, int channels)
        => _engine?.Process(data, channels);
}
```

### 3.4 DLL配置構造

```
ProjectRoot/
└── Assets/
    └── Plugins/
        ├── x86_64/
        │   └── acoustic_engine.dll
        ├── x86/
        │   └── acoustic_engine.dll        # オプション
        ├── macOS/
        │   └── acoustic_engine.bundle
        └── Linux/
            └── libacoustic_engine.so
```

---

## 4. Unreal Engine 統合

### 4.1 プラグイン構造

```
AcousticEnginePlugin/
├── AcousticEngine.uplugin
├── Source/
│   └── AcousticEngine/
│       ├── Public/
│       │   ├── AcousticEngineModule.h
│       │   └── AcousticEngineSourceEffect.h
│       └── Private/
│           ├── AcousticEngineModule.cpp
│           └── AcousticEngineSourceEffect.cpp
└── ThirdParty/
    └── AcousticEngine/
        ├── include/
        │   └── acoustic_engine.h
        └── lib/
            ├── Win64/acoustic_engine.dll
            ├── Mac/libacoustic_engine.dylib
            └── Linux/libacoustic_engine.so
```

### 4.2 モジュール実装

```cpp
// AcousticEngineModule.cpp
void FAcousticEngineModule::StartupModule()
{
    FString LibPath = FPaths::Combine(
        IPluginManager::Get().FindPlugin("AcousticEngine")->GetBaseDir(),
        TEXT("ThirdParty/AcousticEngine/lib"),
        FPlatformProcess::GetBinariesSubdirectory(),
        TEXT("acoustic_engine")
    );
    DllHandle = FPlatformProcess::GetDllHandle(*LibPath);
}

void FAcousticEngineModule::ShutdownModule()
{
    if (DllHandle) FPlatformProcess::FreeDllHandle(DllHandle);
}
```

---

## 5. VST3 / AU 統合

### 5.1 VST3 パラメータマッピング

| AE Parameter | VST3 Parameter | Range | Default |
|-------------|----------------|-------|---------|
| distance | kParamDistance | 0.1-1000 | 10.0 |
| room_size | kParamRoomSize | 0.0-1.0 | 0.5 |
| brightness | kParamBrightness | -1.0-1.0 | 0.0 |
| width | kParamWidth | 0.0-2.0 | 1.0 |
| dry_wet | kParamDryWet | 0.0-1.0 | 0.5 |
| intensity | kParamIntensity | 0.0-1.0 | 1.0 |
| scenario | kParamScenario | 0-16 (enum) | 0 |

### 5.2 AU v3 統合 (Swift)

```swift
// AcousticEngineAU.swift
import AudioToolbox
import AVFoundation

class AcousticEngineAU: AUAudioUnit {
    private var engine: OpaquePointer?
    private let distanceParam: AUParameter
    private let roomSizeParam: AUParameter

    override init(componentDescription: AudioComponentDescription,
                  options: AudioComponentInstantiationOptions) throws {
        // パラメータ定義
        distanceParam = AUParameterTree.createParameter(
            withIdentifier: "distance", name: "Distance",
            address: 0, min: 0.1, max: 1000, unit: .meters,
            unitName: nil, valueStrings: nil, dependentParameters: nil
        )
        // ...
        try super.init(componentDescription: componentDescription, options: options)
    }

    override func allocateRenderResources() throws {
        try super.allocateRenderResources()
        var config = ae_get_default_config()
        engine = ae_create_engine(&config)
    }
}
```

---

## 6. ビルド設定

### 6.1 CMake オプション

```cmake
# プラグインビルド用オプション
option(AE_BUILD_UNITY_PLUGIN "Build Unity plugin" OFF)
option(AE_BUILD_UE_PLUGIN "Build Unreal Engine plugin" OFF)
option(AE_BUILD_VST3 "Build VST3 plugin" OFF)
option(AE_BUILD_AU "Build Audio Unit plugin" OFF)

# シンボル可視性
set(CMAKE_C_VISIBILITY_PRESET hidden)
set(CMAKE_CXX_VISIBILITY_PRESET hidden)
set(CMAKE_VISIBILITY_INLINES_HIDDEN YES)
```

### 6.2 プラットフォーム別出力

| Platform | Output | Install Path |
|----------|--------|--------------|
| Windows | acoustic_engine.dll | bin/ |
| macOS | libacoustic_engine.dylib | lib/ |
| macOS (Framework) | AcousticEngine.framework | Frameworks/ |
| Linux | libacoustic_engine.so | lib/ |
| iOS | libacoustic_engine.a | lib/ |

---

## 7. テスト要件

### 7.1 統合テスト項目

| テスト | 内容 | 合格基準 |
|-------|------|---------|
| Unity AudioFilter | OnAudioFilterRead での処理 | ノイズなし、レイテンシ < 10ms |
| UE SourceEffect | Submix 経由での処理 | 音質劣化なし |
| VST3 プロセッサ | DAW内での処理 | クリックノイズなし |
| スレッド安全性 | 並列パラメータ更新 | デッドロック/クラッシュなし |
| メモリリーク | 繰り返し create/destroy | ヒープ増加なし |

### 7.2 パフォーマンス基準

| 指標 | 基準値 |
|-----|-------|
| CPU使用率 (stereo, 512 samples) | < 5% (single core) |
| レイテンシ | < 1 buffer |
| メモリ使用量 (インスタンスあたり) | < 10 MB |

---

## 8. 実装優先順位

| Phase | 機能 | 工数見積 |
|-------|-----|---------|
| Phase 1 | Unity P/Invoke + 高レベルラッパー | 3日 |
| Phase 1 | Windows/macOS/Linux DLL ビルド | 2日 |
| Phase 2 | UE5 プラグイン | 5日 |
| Phase 2 | VST3 プラグイン | 5日 |
| Phase 3 | AU v3 プラグイン | 3日 |
| Phase 3 | TouchDesigner Operator | 2日 |

---

## 9. 参考資料

- [Unity Native Plugin Manual](https://docs.unity3d.com/Manual/NativePlugins.html)
- [UE5 Third Party Libraries](https://docs.unrealengine.com/5.0/en-US/third-party-libraries-in-unreal-engine/)
- [VST3 SDK Documentation](https://steinbergmedia.github.io/vst3_dev_portal/)
- [Audio Unit Hosting Guide](https://developer.apple.com/documentation/audiotoolbox/audio_unit_hosting_guide)
