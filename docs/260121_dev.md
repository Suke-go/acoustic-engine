# Acoustic Engine 機能拡張要件定義書

> **文書ID**: 260121_dev  
> **作成日**: 2026-01-21  
> **目的**: 聴覚モデリング機能の拡張（AMT互換性向上）

---

## 1. 概要

本文書は、Auditory Modeling Toolbox (AMT) との比較分析に基づき、Acoustic Engine に追加すべき聴覚モデリング機能を定義する。

### 1.1 背景

AMT は MATLAB/Octave ベースの聴覚モデリングツールボックスで、50以上の科学的に検証されたモデルを収録している。Acoustic Engine が聴覚科学研究でも使用されることを想定し、以下の機能を追加する。

### 1.2 追加機能カテゴリ

| カテゴリ | 優先度 | 状態 |
|---------|--------|------|
| 聴覚フィルタバンク | 高 | 新規実装 |
| 蝸牛・有毛細胞モデル | 高 | 新規実装 |
| 適応ループ | 高 | 新規実装 |
| 変調フィルタバンク | 中 | 新規実装 |
| バイノーラルマスキング | 低 | 新規実装 |
| Zwicker ラウドネス (完全版) | 中 | 拡張 |
| シャープネス計算 | 中 | 拡張 |
| ラフネス計算 | 中 | 拡張 |
| 変動強度計算 | 中 | 拡張 |
| 音声明瞭度モデル | 低 | 拡張 |

---

## 2. 新規実装機能

### 2.1 聴覚フィルタバンク (Auditory Filterbank)

#### 2.1.1 Gammatone フィルタバンク

Patterson (1988)、Slaney (1993) に基づく標準的な聴覚フィルタバンク。

**数学的定義**:

```
g(t) = a·t^(n-1)·cos(2πf_c·t + φ)·exp(-2πb·t)

ここで:
  n: フィルタ次数 (通常 4)
  f_c: 中心周波数 (Hz)
  b: 帯域幅パラメータ (ERB依存)
  φ: 位相 (通常 0)
  a: 正規化係数
```

**ERB (Equivalent Rectangular Bandwidth)**:

```
ERB(f) = 24.7 × (4.37 × f/1000 + 1)

中心周波数の配置:
  f_c[k] = -(ERB_min/p) + (f_high + ERB_min/p) × exp(k × (-log(f_high + ERB_min/p) + log(f_low + ERB_min/p)) / n_channels)
  
  p = 9.265  (定数)
```

| パラメータ | 説明 | デフォルト値 | 範囲 |
|-----------|------|-------------|------|
| `n_channels` | チャンネル数 | 32 | 4 - 64 |
| `f_low` | 最低周波数 (Hz) | 80 | 20 - 500 |
| `f_high` | 最高周波数 (Hz) | 16000 | 4000 - 22050 |
| `filter_order` | フィルタ次数 | 4 | 1 - 8 |

**API**:

```c
typedef struct ae_gammatone ae_gammatone_t;

typedef struct {
    uint32_t n_channels;      /* チャンネル数 */
    float f_low;              /* 最低周波数 (Hz) */
    float f_high;             /* 最高周波数 (Hz) */
    uint8_t filter_order;     /* フィルタ次数 */
    uint32_t sample_rate;     /* サンプルレート */
} ae_gammatone_config_t;

/* Gammatone フィルタバンクの作成・破棄 */
AE_API ae_gammatone_t* ae_gammatone_create(const ae_gammatone_config_t* config);
AE_API void ae_gammatone_destroy(ae_gammatone_t* gt);

/* フィルタバンク処理 */
AE_API ae_result_t ae_gammatone_process(
    ae_gammatone_t* gt,
    const float* input,
    size_t n_samples,
    float** output  /* [n_channels][n_samples] */
);

/* 中心周波数の取得 */
AE_API ae_result_t ae_gammatone_get_center_frequencies(
    ae_gammatone_t* gt,
    float* frequencies,  /* [n_channels] */
    size_t* n_channels
);
```

---

#### 2.1.2 DRNL フィルタバンク (Dual-Resonance Nonlinear)

Meddis et al. (2001) に基づく、より生理学的に正確なモデル。

**構造**:

```
入力 ──┬── [Linear Path] ──────────────────────────────┬── 出力
       │    └─ GT → LP → Gain                          │
       │                                               │
       └── [Nonlinear Path] ──────────────────────────┘
            └─ GT → LP → Broken-stick compression → GT → LP
```

**Broken-stick 圧縮関数**:

```
y = sign(x) × min(a|x|, b|x|^c)

ここで:
  a: 線形ゲイン (弱い入力)
  b: 圧縮後のゲイン
  c: 圧縮率 (通常 0.2 - 0.3)
```

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `compression_ratio` | 圧縮率 | 0.25 |
| `compression_threshold` | 圧縮開始レベル (dB) | 20 |
| `linear_gain` | 線形パスゲイン | 0.01 |

**API**:

```c
typedef struct ae_drnl ae_drnl_t;

typedef struct {
    uint32_t n_channels;
    float f_low;
    float f_high;
    float compression_ratio;
    float compression_threshold_db;
} ae_drnl_config_t;

AE_API ae_drnl_t* ae_drnl_create(const ae_drnl_config_t* config);
AE_API void ae_drnl_destroy(ae_drnl_t* drnl);
AE_API ae_result_t ae_drnl_process(
    ae_drnl_t* drnl,
    const float* input,
    size_t n_samples,
    float** output
);
```

---

### 2.2 蝸牛・有毛細胞モデル

#### 2.2.1 内有毛細胞 (IHC) モデル

Meddis (1986, 2006) または Zilany (2014) に基づく半波整流 + 低域通過。

**簡略モデル (本実装)**:

```
IHC出力 = LPF(max(0, BM_velocity))^θ

ここで:
  BM_velocity: 基底膜振動速度
  θ: 圧縮指数 (通常 0.3)
  LPF: 低域通過フィルタ (fc ≈ 1000-3000 Hz)
```

**API**:

```c
typedef struct {
    float compression_exponent;  /* 圧縮指数 θ */
    float lpf_cutoff_hz;         /* LPF カットオフ周波数 */
} ae_ihc_config_t;

AE_API ae_result_t ae_ihc_envelope(
    const float* basilar_membrane_output,
    size_t n_samples,
    const ae_ihc_config_t* config,
    float* ihc_output
);
```

---

#### 2.2.2 適応ループ (Adaptation Loop)

Dau et al. (1996) の5段カスケード適応モデル。

**数学的定義**:

```
各ステージ:
  dA/dt = (1/τ) × (A_min + |A - A_min|) × (input - A)

5段カスケード:
  τ = [5, 50, 129, 253, 500] ms (デフォルト)
```

**知覚的意義**:
- 急速な音量変化への適応
- フォワードマスキングのモデル化
- 時間解像度の制限

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `n_stages` | ステージ数 | 5 |
| `time_constants` | 各ステージの時定数 (ms) | [5, 50, 129, 253, 500] |
| `min_output` | 最小出力値 | 1e-5 |

**API**:

```c
typedef struct ae_adaptloop ae_adaptloop_t;

typedef struct {
    uint8_t n_stages;             /* ステージ数 (1-5) */
    float time_constants[5];      /* 時定数 (ms) */
    float min_output;             /* 最小出力 */
    uint32_t sample_rate;
} ae_adaptloop_config_t;

AE_API ae_adaptloop_t* ae_adaptloop_create(const ae_adaptloop_config_t* config);
AE_API void ae_adaptloop_destroy(ae_adaptloop_t* al);
AE_API ae_result_t ae_adaptloop_process(
    ae_adaptloop_t* al,
    const float* input,
    size_t n_samples,
    float* output
);
AE_API void ae_adaptloop_reset(ae_adaptloop_t* al);
```

---

### 2.3 変調フィルタバンク (Modulation Filterbank)

Dau et al. (1997) に基づく、時間変調構造の解析。

**構造**:

```
聴覚フィルタバンク出力
    │
    ▼
IHC + 適応ループ
    │
    ▼
┌─────────────────────────────┐
│   Modulation Filterbank     │
│  ┌────┐ ┌────┐ ┌────┐ ...  │
│  │0.5 │ │ 1  │ │ 2  │ ...  │  ← 変調周波数 (Hz)
│  │ Hz │ │ Hz │ │ Hz │       │
│  └────┘ └────┘ └────┘       │
└─────────────────────────────┘
    │
    ▼
変調スペクトログラム [audio_channel × mod_channel × time]
```

**変調フィルタ設計**:

```
Q = 1 (低変調周波数: < 10 Hz)
Q = 2 (高変調周波数: ≥ 10 Hz)

中心周波数: [0.5, 1, 2, 4, 8, 16, 32, 64, 128, 256] Hz
```

| パラメータ | 説明 | デフォルト値 |
|-----------|------|-------------|
| `mod_center_freqs` | 変調中心周波数 (Hz) | [0.5, 1, 2, 4, 8, 16, 32, 64, 128, 256] |
| `n_mod_channels` | 変調チャンネル数 | 10 |
| `q_low` | 低周波数Q値 | 1 |
| `q_high` | 高周波数Q値 | 2 |

**API**:

```c
typedef struct ae_modfb ae_modfb_t;

typedef struct {
    float* mod_center_freqs;      /* 変調中心周波数配列 */
    uint8_t n_mod_channels;       /* 変調チャンネル数 */
    float q_low;
    float q_high;
    float q_transition_freq;      /* QがLow→Highに変わる周波数 */
    uint32_t sample_rate;
} ae_modfb_config_t;

AE_API ae_modfb_t* ae_modfb_create(const ae_modfb_config_t* config);
AE_API void ae_modfb_destroy(ae_modfb_t* mfb);
AE_API ae_result_t ae_modfb_process(
    ae_modfb_t* mfb,
    const float* input,           /* IHC/適応ループ後の信号 */
    size_t n_samples,
    float* output                 /* [n_mod_channels][n_samples] */
);
```

---

### 2.4 バイノーラルマスキングモデル

#### 2.4.1 BMLD (Binaural Masking Level Difference)

Durlach (1963) の等化キャンセルモデルに基づくBMLDの推定。

**BMLD計算**:

```
BMLD = 10 × log10(1 + (ρ_N × ρ_S - ρ_NS)² / (1 - ρ_N²))

ここで:
  ρ_N: ノイズの左右相関
  ρ_S: 信号の左右相関
  ρ_NS: 信号-ノイズ間相関
  
簡略化 (Sπ N0):
  BMLD ≈ 15 dB (500 Hz)
  BMLD ≈ 3 dB (2000 Hz)
```

**API**:

```c
typedef struct {
    float signal_frequency_hz;
    float noise_bandwidth_hz;
    float signal_correlation;     /* -1 (Sπ) to +1 (S0) */
    float noise_correlation;      /* -1 to +1 */
} ae_bmld_params_t;

AE_API float ae_compute_bmld(const ae_bmld_params_t* params);
```

---

## 3. 拡張機能

### 3.1 Zwicker ラウドネス (ISO 532-1/2 完全実装)

現在の簡略版を ISO 532-1 (定常音) / ISO 532-2 (時変音) 完全準拠に拡張。

#### 3.1.1 特定ラウドネス (Specific Loudness)

```
N'(z) = 特定ラウドネス (sone/Bark)

N = ∫₀²⁴ N'(z) dz  (総ラウドネス)
```

**拡張API**:

```c
typedef struct {
    float specific_loudness[AE_NUM_BARK_BANDS];  /* 各Barkバンドの特定ラウドネス */
    float total_loudness_sone;                   /* 総ラウドネス (sone) */
    float loudness_level_phon;                   /* ラウドネスレベル (phon) */
    float peak_loudness_sone;                    /* ピーク特定ラウドネス */
    uint8_t peak_bark_band;                      /* ピークのBarkバンド */
} ae_zwicker_loudness_t;

typedef enum {
    AE_LOUDNESS_METHOD_ISO_532_1,  /* 定常音 (Zwicker) */
    AE_LOUDNESS_METHOD_ISO_532_2,  /* 時変音 */
    AE_LOUDNESS_METHOD_MOORE       /* Moore-Glasberg */
} ae_loudness_method_t;

AE_API ae_result_t ae_analyze_zwicker_loudness(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    ae_loudness_method_t method,
    ae_zwicker_loudness_t* out
);
```

---

### 3.2 シャープネス (DIN 45692)

現在の `ae_timbral_params_t.sharpness` に対応する計算を実装。

**計算式**:

```
Sharpness = 0.11 × ∫₀²⁴ N'(z) × g(z) × z dz / N

ここで:
  g(z) = 1                     (z ≤ 15 Bark)
  g(z) = 0.066 × exp(0.171z)   (z > 15 Bark)
```

**API**:

```c
typedef enum {
    AE_SHARPNESS_DIN_45692,    /* DIN 45692 標準 */
    AE_SHARPNESS_AURES,        /* Aures モデル */
    AE_SHARPNESS_BISMARCK      /* von Bismarck モデル */
} ae_sharpness_method_t;

AE_API ae_result_t ae_compute_sharpness(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    ae_sharpness_method_t method,
    float* sharpness_acum
);
```

---

### 3.3 ラフネス (Roughness)

Daniel & Weber (1997) に基づくラフネス計算。

**原理**:

```
Roughness ∝ 変調深度 × 変調周波数依存重み

ピーク知覚: ~70 Hz 変調
範囲: 15 - 300 Hz 変調
```

**計算アプローチ**:

1. 聴覚フィルタバンクで分解
2. 各チャンネルの包絡線を抽出
3. 変調スペクトルを計算
4. 変調深度と周波数で重み付け積分

**API**:

```c
AE_API ae_result_t ae_compute_roughness(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    float* roughness_asper
);

/* 時間変化するラフネス */
AE_API ae_result_t ae_compute_roughness_over_time(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    float hop_size_ms,
    float* roughness_array,   /* [n_frames] */
    size_t* n_frames
);
```

---

### 3.4 変動強度 (Fluctuation Strength)

Fastl & Zwicker に基づく変動強度計算。

**原理**:

```
Fluctuation ∝ 変調深度² × 周波数依存重み

ピーク知覚: ~4 Hz 変調
範囲: 0.5 - 20 Hz 変調

重み関数:
  w(f_mod) = 1 / ((f_mod/4) + (4/f_mod))
```

**API**:

```c
AE_API ae_result_t ae_compute_fluctuation_strength(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    float* fluctuation_vacil
);
```

---

### 3.5 音声明瞭度モデル

#### 3.5.1 SII (Speech Intelligibility Index)

ANSI S3.5 に基づく音声明瞭度指数。

**計算**:

```
SII = Σᵢ Iᵢ × Aᵢ × Wᵢ

ここで:
  Iᵢ: 重要度関数 (周波数バンド依存)
  Aᵢ: 可聴度関数
  Wᵢ: バンド重み
```

| パラメータ | 説明 |
|-----------|------|
| `speech_level` | 発話レベル (dB SPL) |
| `noise_level` | 背景ノイズレベル (dB SPL) |
| `reverberation_time` | 残響時間 (秒) |

**API**:

```c
typedef struct {
    float speech_level_db;
    float noise_level_db;
    float rt60_seconds;
    bool use_extended_sii;       /* 拡張SII使用 */
} ae_sii_params_t;

AE_API ae_result_t ae_compute_sii(
    const ae_sii_params_t* params,
    float* sii_value            /* 0.0 - 1.0 */
);
```

---

## 4. データ構造のまとめ

### 4.1 新規追加構造体

```c
/* 聴覚処理パイプライン出力 */
typedef struct {
    float** gammatone_output;     /* [n_audio_ch][n_samples] */
    float** ihc_output;           /* [n_audio_ch][n_samples] */
    float** adaptation_output;    /* [n_audio_ch][n_samples] */
    float*** modulation_output;   /* [n_audio_ch][n_mod_ch][n_samples] */
    uint32_t n_audio_channels;
    uint32_t n_modulation_channels;
    size_t n_samples;
} ae_auditory_repr_t;

/* 聴覚処理パイプライン設定 */
typedef struct {
    ae_gammatone_config_t gammatone;
    ae_ihc_config_t ihc;
    ae_adaptloop_config_t adaptation;
    ae_modfb_config_t modulation;
    bool compute_gammatone;
    bool compute_ihc;
    bool compute_adaptation;
    bool compute_modulation;
} ae_auditory_pipeline_config_t;

/* パイプライン処理 */
AE_API ae_result_t ae_compute_auditory_representation(
    ae_engine_t* engine,
    const ae_audio_buffer_t* signal,
    const ae_auditory_pipeline_config_t* config,
    ae_auditory_repr_t* out
);
AE_API void ae_free_auditory_representation(ae_auditory_repr_t* repr);
```

---

## 5. 実装優先順位

### Phase 1 (優先度: 高) - v0.2.0

| 機能 | 工数見積 | 依存関係 |
|-----|---------|---------|
| Gammatone フィルタバンク | 3日 | なし |
| IHC エンベロープ | 1日 | Gammatone |
| 適応ループ | 2日 | IHC |
| Zwicker ラウドネス完全版 | 2日 | Gammatone |

### Phase 2 (優先度: 中) - v0.3.0

| 機能 | 工数見積 | 依存関係 |
|-----|---------|---------|
| 変調フィルタバンク | 2日 | 適応ループ |
| ラフネス計算 | 2日 | 変調フィルタバンク |
| シャープネス計算 | 1日 | Zwicker ラウドネス |
| 変動強度計算 | 1日 | 変調フィルタバンク |

### Phase 3 (優先度: 低) - v0.4.0

| 機能 | 工数見積 | 依存関係 |
|-----|---------|---------|
| DRNL フィルタバンク | 3日 | なし |
| BMLD | 1日 | なし |
| SII | 2日 | なし |

---

## 6. テスト要件

### 6.1 検証方法

| 機能 | 検証方法 | 参照データ |
|-----|---------|-----------|
| Gammatone | AMT `gammatone.m` 出力との比較 | Patterson (1988) |
| 適応ループ | AMT `adaptloop.m` 出力との比較 | Dau et al. (1996) |
| Zwicker ラウドネス | ISO 532-1 テストトーン | ISO 532-1 Annex |
| シャープネス | 既知の音色との比較 | DIN 45692 |
| ラフネス | AM トーンでのピーク確認 | Daniel & Weber (1997) |

### 6.2 テストケース例

```c
/* Gammatone テスト: インパルス応答 */
void test_gammatone_impulse_response(void) {
    ae_gammatone_config_t config = {
        .n_channels = 32,
        .f_low = 80.0f,
        .f_high = 16000.0f,
        .filter_order = 4,
        .sample_rate = 48000
    };
    
    ae_gammatone_t* gt = ae_gammatone_create(&config);
    
    float impulse[1024] = {0};
    impulse[0] = 1.0f;
    
    float* output[32];
    ae_gammatone_process(gt, impulse, 1024, output);
    
    /* 各チャンネルのピーク時刻が中心周波数に依存することを確認 */
    /* 高周波チャンネルほど早くピークする */
    
    ae_gammatone_destroy(gt);
}

/* 適応ループテスト: フォワードマスキング */
void test_adaptloop_forward_masking(void) {
    /* 短いマスカー後の検出閾値上昇を確認 */
}

/* Zwicker ラウドネステスト: 1kHz 40dB = 1 sone */
void test_zwicker_loudness_reference(void) {
    /* 1kHz, 40dB SPL の純音が 1 sone になることを確認 */
}
```

---

## 7. 参考文献

1. Patterson, R. D. (1988). "An efficient auditory filterbank based on the gammatone function."
2. Slaney, M. (1993). "An efficient implementation of the Patterson-Holdsworth auditory filter bank."
3. Meddis, R. et al. (2001). "A computational algorithm for computing nonlinear auditory frequency selectivity."
4. Dau, T. et al. (1996). "A quantitative model of the 'effective' signal processing in the auditory system."
5. Dau, T. et al. (1997). "Modeling auditory processing of amplitude modulation."
6. Daniel, P. & Weber, R. (1997). "Psychoacoustical roughness: Implementation of an optimized model."
7. Fastl, H. & Zwicker, E. (2007). "Psychoacoustics: Facts and Models." 3rd ed.
8. ISO 532-1:2017. "Acoustics — Methods for calculating loudness — Part 1: Zwicker method."
9. ANSI S3.5-1997. "Methods for Calculation of the Speech Intelligibility Index."
10. Durlach, N. I. (1963). "Equalization and cancellation theory of binaural masking-level differences."
